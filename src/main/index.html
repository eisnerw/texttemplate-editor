<!DOCTYPE html>
<html>
<head>
	<title>TextTemplate Editor</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
	<link rel="stylesheet" href="css/style.css">
	<style>
	pre {
		overflow-x: auto;
		white-space: pre-wrap;
		white-space: -moz-pre-wrap;
		white-space: -pre-wrap;
		white-space: -o-pre-wrap;
		word-wrap: break-word;
	}
	</style>
</head>
<body>

<h2>TextTemplate Editor</h2>
<div id="container" style="width:800px;height:600px;border:1px solid grey; float:left"></div>
<h2 id="collapser">-</h2>
<div><pre id="parsed">this is where the parsed stuff should go</pre></div>
<div><pre id="interpolated"></pre></div>
<script src="node_modules/monaco-editor/min/vs/loader.js"></script>
<script src="js/main.js"></script>

<script>
	require.config({ paths: { 'vs': 'node_modules/monaco-editor/min/vs' }});

	require(['vs/editor/editor.main'], function() {
		monaco.languages.register({ id: 'texttemplate' });

		let parserFacade;

		monaco.languages.setTokensProvider('texttemplate', new TextTemplateTokensProvider.TextTemplateTokensProvider());
		let config = {"surroundingPairs": [{ "open": "{", "close": "}" }], "autoClosingPairs": [{ "open": "{", "close": "}" }], "brackets": [["{", "}"]] };
		monaco.languages.setLanguageConfiguration("texttemplate", config);
		monaco.languages.registerFoldingRangeProvider("texttemplate", {
			provideFoldingRanges: function(model, context, token) {
				return parserFacade.provideFoldingRanges(model, context, token);
			}
		});

		let literalFg = '3b8737';
		let idFg = '344482';
		let symbolsFg = '000000';
		let keywordFg = '7132a8';
		let errorFg = 'ff0000';

		monaco.editor.defineTheme('myCoolTheme', {
			base: 'vs',
			inherit: false,
			rules: [
				{ token: 'number_lit.texttemplate',   foreground: literalFg },

				{ token: 'id.texttemplate',           foreground: idFg,       fontStyle: 'italic' },

				{ token: 'lparen.texttemplate',       foreground: symbolsFg },
				{ token: 'rparen.texttemplate',       foreground: symbolsFg },

				{ token: 'equal.texttemplate',        foreground: symbolsFg },
				{ token: 'minus.texttemplate',        foreground: symbolsFg },
				{ token: 'plus.texttemplate',         foreground: symbolsFg },
				{ token: 'div.texttemplate',          foreground: symbolsFg },
				{ token: 'mul.texttemplate',          foreground: symbolsFg },

				{ token: 'input_kw.texttemplate',     foreground: keywordFg,  fontStyle: 'bold' },
				{ token: 'output_kw.texttemplate',    foreground: keywordFg,  fontStyle: 'bold' },

				{ token: 'unrecognized.texttemplate', foreground: errorFg }
			]
		});

		let editor = monaco.editor.create(document.getElementById('container'), {
			value: [
 				'// data context:',
				'{\'{"firstName": "John", "lastName": "Smith", "pets":[',
				'{"type":"dog", "name": "Toto"}',
				',{"type":"cat", "name": "Dolly"}',
				',{"type":"zebra", "name": "Stripes"}',
				']}\':',
 				'// Template:',
				'[{"Hello"} {lastName}, {firstName} with {pets.Exists()=>',
				'   [{pets:#formatPet.Anded()}]',
				'   ,[no pets]',
				'}!!]}',
				'',
				' // external json data and an external subtemplate',
				'// {\'https://api.github.com/users/eisnerw/repos\': #formatGitRepos}', 
 				'',
 				'Subtemplates:',
 				'',
 				'{#formatPet:[a {type} named {name}]}',
 				'{#formatPets:[{pets:[a big {type} named {name}].Anded()}]}',
				''
			].join('\n'),
			language: 'texttemplate',
			theme: 'myCoolTheme',
			scrollbar: {
				// Subtle shadows to the left & top. Defaults to true.
				useShadows: false,

				// Render vertical arrows. Defaults to false.
				verticalHasArrows: true,
				// Render horizontal arrows. Defaults to false.
				horizontalHasArrows: true,

				// Render vertical scrollbar.
				// Accepted values: 'auto', 'visible', 'hidden'.
				// Defaults to 'auto'
				vertical: 'visible',
				// Render horizontal scrollbar.
				// Accepted values: 'auto', 'visible', 'hidden'.
				// Defaults to 'auto'
				horizontal: 'visible',

				verticalScrollbarSize: 17,
				horizontalScrollbarSize: 17,
				arrowSize: 30
			}			
		});
		editor.onDidChangeModelContent(function (e) {
			let code = editor.getValue()
			let model = monaco.editor.getModels()[0];
			if (!ParserFacade && !parserFacade){
				return; // protect against an unknown error that can occur during editing if keystrokes are frequent
			} else {
				if (ParserFacade && !parserFacade){
					parserFacade = ParserFacade;
				}
			}
			setTimeout(function(){
				parserFacade.inputChanged(code, model, monaco);
			},0);
		});
		monaco.languages.registerDefinitionProvider('texttemplate', {
			provideDefinition: function(model,position, token){
				console.log("got here");
			}
		});
	});
</script>
<!--jQuery-->
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script>
	$("#collapser").click(function() {
		if (document.getElementById('collapser').innerText == '+'){
			$("#parsed").show()
			document.getElementById('collapser').innerText = '-';
		} else {
			$("#parsed").hide()
			document.getElementById('collapser').innerText = '+';
		}
	});
</script>
</body>
</html>